name: Create and publish artifacts

on:
  push:
    branches:
      - main
  schedule:
    - cron: "2 02 4 * *"

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # ratchet:actions/checkout@v6
      - uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # ratchet:actions/setup-go@v6
        with:
          go-version: "stable"

      - name: Lint
        run: |
          set -euo pipefail

          gofmt -s -w .
          git diff --exit-code

          go vet ./...

          go mod tidy
          git diff --exit-code

          go mod download
          go mod verify

          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...

  build-and-push-image:
    name: Build and push container image
    needs: lint
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write
      artifact-metadata: write

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # ratchet:actions/checkout@v6

      - name: Authenticate to GHCR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          echo "${GITHUB_TOKEN}" | buildah login ghcr.io -u "${GITHUB_ACTOR}" --password-stdin --compat-auth-file=/home/runner/.docker/config.json

      - name: Build and push image
        id: build
        run: |
          set -euo pipefail

          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          brew install cosign

          IMAGE="${REGISTRY}/${IMAGE_NAME}:latest"
          CREATED="$(date -u +%Y-%m-%dT%H:%M:%SZ)"

          buildah build \
            --jobs 2 \
            --platform=linux/arm64,linux/amd64 \
            --manifest "${IMAGE}" \
            --label org.opencontainers.image.source="https://github.com/${GITHUB_REPOSITORY}" \
            --label org.opencontainers.image.revision="${GITHUB_SHA}" \
            --label org.opencontainers.image.created="${CREATED}" \
            .

          buildah push "${IMAGE}"
          buildah manifest push --all "${IMAGE}" "docker://${IMAGE}"
          DIGEST="$(skopeo inspect docker://${IMAGE} | jq -r .Digest)"
          echo "digest=${DIGEST}" >> "$GITHUB_OUTPUT"

          cosign sign --recursive --yes "${IMAGE}@${DIGEST}"

      - name: Generate image attestation
        uses: actions/attest-build-provenance@00014ed6ed5efc5b1ab7f7f34a39eb55d41aa4f8 # ratchet:actions/attest-build-provenance@v3.1.0
        with:
          subject-name: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          subject-digest: ${{ steps.build.outputs.digest }}
          push-to-registry: true

  releases:
    name: Build and release Go binaries
    needs: lint
    runs-on: ubuntu-latest

    permissions:
      contents: write
      id-token: write
      attestations: write

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # ratchet:actions/checkout@v6
      - uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # ratchet:actions/setup-go@v6
        with:
          go-version: "stable"

      - name: Build binaries for all architectures
        env:
          CGO_ENABLED: 0
          NAME: ${{ github.event.repository.name }}
        run: |
          set -euo pipefail

          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          brew install cosign

          for arch in amd64 arm64; do
            GOOS=linux GOARCH=$arch go build -trimpath -ldflags="-s -w" -o "$NAME" main.go

            zip -q "$NAME-linux-${arch}.zip" "$NAME" "${NAME}-${arch}.sigstore.json"
            cosign sign-blob --yes "$NAME-linux-${arch}.zip" --bundle "$NAME-linux-${arch}.zip.sigstore.json"
            rm "$NAME"
          done

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@00014ed6ed5efc5b1ab7f7f34a39eb55d41aa4f8 # ratchet:actions/attest-build-provenance@v3.1.0
        with:
          subject-path: "*.zip"

      - name: Create Github release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          gh release delete latest --yes || true
          gh release create latest *.zip *.sigstore.json --title "latest"
